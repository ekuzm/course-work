@startuml course-work
' === Общие параметры ===
left to right direction
skinparam monochrome true
skinparam shadowing false
skinparam backgroundColor white
skinparam defaultFontColor black
skinparam dpi 120
scale 0.7

' --- Уменьшаем расстояния ---
skinparam ranksep 0.3
skinparam nodesep 0.3
skinparam linetype ortho

' --- Минимализм и сжатие ---
hide empty members
hide circle
hide stereotype
skinparam classAttributeIconSize 0
skinparam classVisibilityIconSize 0
skinparam class {
    AttributeFontSize 11
    FontSize 12
    Padding 2
    BackgroundColor white
    BorderColor black
}

' === Core Domain - Основные классы домена ===
together {
    class Employee {
        - id : int
        - name : QString
        - position : QString
        - salary : double
        - department : QString
        - isActive : bool
        - employmentRate : double
        - weeklyHoursCapacity : int
        - currentWeeklyHours : int
        - assignedProjects : vector
        --
        + Employee(int, QString, QString, double, QString, double, int)
        + ~Employee()
        + getEmployeeType() : QString
        + getDetails() : QString
        + calculateBonus() : double
        + getId() : int
        + getName() : QString
        + getPosition() : QString
        + getSalary() : double
        + getDepartment() : QString
        + getIsActive() : bool
        + getEmploymentRate() : double
        + getWeeklyHoursCapacity() : int
        + getCurrentWeeklyHours() : int
        + isAvailable(int) : bool
        + getAvailableHours() : int
        + addWeeklyHours(int) : void
        + removeWeeklyHours(int) : void
        + getAssignedProjects() : vector
        + addAssignedProject(int) : void
        + removeAssignedProject(int) : void
        + isAssignedToProject(int) : bool
        + setIsActive(bool) : void
    }

    class Manager {
        - managedProjectId : int
        --
        + Manager(int, QString, double, QString, int, double)
        + getEmployeeType() : QString
        + getDetails() : QString
        + calculateBonus() : double
        + getManagedProjectId() : int
        + setManagedProjectId(int) : void
    }

    class Developer {
        - programmingLanguage : QString
        - yearsOfExperience : int
        --
        + Developer(int, QString, double, QString, QString, int, double)
        + getEmployeeType() : QString
        + getDetails() : QString
        + calculateBonus() : double
        + getProgrammingLanguage() : QString
        + getYearsOfExperience() : int
    }

    class Designer {
        - designTool : QString
        - numberOfProjects : int
        --
        + Designer(int, QString, double, QString, QString, int, double)
        + getEmployeeType() : QString
        + getDetails() : QString
        + calculateBonus() : double
        + getDesignTool() : QString
        + getNumberOfProjects() : int
    }

    class QA {
        - testingType : QString
        - bugsFound : int
        --
        + QA(int, QString, double, QString, QString, int, double)
        + getEmployeeType() : QString
        + getDetails() : QString
        + calculateBonus() : double
        + getTestingType() : QString
        + getBugsFound() : int
    }

    class Task {
        - id : int
        - name : QString
        - type : QString
        - estimatedHours : int
        - allocatedHours : int
        - priority : int
        - status : QString
        --
        + Task(int, QString, QString, int, int)
        + getId() : int
        + getName() : QString
        + getType() : QString
        + getEstimatedHours() : int
        + getAllocatedHours() : int
        + getPriority() : int
        + getStatus() : QString
        + setEstimatedHours(int) : void
        + setAllocatedHours(int) : void
        + addAllocatedHours(int) : void
        + setStatus(QString) : void
    }

    class Project {
        - id : int
        - name : QString
        - description : QString
        - status : QString
        - startDate : QDate
        - endDate : QDate
        - budget : double
        - clientName : QString
        - initialEstimatedHours : int
        - allocatedHours : int
        - employeeCosts : double
        - tasks : vector
        --
        + Project(int, QString, QString, QString, QDate, QDate, double, QString, int)
        + getId() : int
        + getName() : QString
        + getDescription() : QString
        + getStatus() : QString
        + getStartDate() : QDate
        + getEndDate() : QDate
        + getBudget() : double
        + getClientName() : QString
        + getEstimatedHours() : int
        + getInitialEstimatedHours() : int
        + getAllocatedHours() : int
        + getEmployeeCosts() : double
        + getTasks() : vector
        + addTask(Task) : void
        + clearTasks() : void
        + getTasksEstimatedTotal() : int
        + getTasksAllocatedTotal() : int
        + getNextTaskId() : int
        + setStatus(QString) : void
        + setBudget(double) : void
        + setEstimatedHours(int) : void
        + setAllocatedHours(int) : void
        + addEmployeeCost(double) : void
        + removeEmployeeCost(double) : void
        + recomputeTotalsFromTasks() : void
        + isActive() : bool
    }

    class EmployeeContainer {
        - employees : vector
        --
        + add(Employee) : void
        + remove(int) : void
        + find(int) : Employee
        + getAll() : vector
        + size() : int
    }

    class ProjectContainer {
        - projects : vector
        --
        + add(Project) : void
        + remove(int) : void
        + find(int) : Project
        + getAll() : vector
        + size() : int
    }

    class Company {
        - name : QString
        - industry : QString
        - location : QString
        - foundedYear : int
        - employees : EmployeeContainer
        - projects : ProjectContainer
        --
        + Company(QString, QString, QString, int)
        + getName() : QString
        + getIndustry() : QString
        + getLocation() : QString
        + getFoundedYear() : int
        + addEmployee(Employee) : void
        + removeEmployee(int) : void
        + getEmployee(int) : Employee
        + getAllEmployees() : vector
        + addProject(Project) : void
        + removeProject(int) : void
        + getProject(int) : Project
        + getAllProjects() : vector
        + addTaskToProject(int, Task) : void
        + getProjectTasks(int) : vector
        + assignEmployeeToTask(int, int, int, int) : void
        + autoAssignEmployeesToProject(int) : void
        + getEmployeeCount() : int
        + getProjectCount() : int
        + getTotalSalaries() : double
        + getTotalBudget() : double
        + getCompanyInfo() : QString
    }

    Employee <|-- Manager
    Employee <|-- Developer
    Employee <|-- Designer
    Employee <|-- QA
    Company *-- EmployeeContainer
    Company *-- ProjectContainer
    EmployeeContainer o-- Employee
    ProjectContainer o-- Project
    Project *-- Task
    Manager --> Project
}

' === Exceptions - Исключения ===
together {
    class BaseException {
        # message : QString
        --
        + BaseException(QString)
        + what() : String
    }

    class EmployeeException {
        + EmployeeException(QString)
    }

    class CompanyException {
        + CompanyException(QString)
    }

    class ProjectException {
        + ProjectException(QString)
    }

    class TaskException {
        + TaskException(QString)
    }

    class FileManagerException {
        + FileManagerException(QString)
    }

    BaseException <|-- EmployeeException
    BaseException <|-- CompanyException
    BaseException <|-- ProjectException
    BaseException <|-- TaskException
    BaseException <|-- FileManagerException
}

' === UI Layer - Пользовательский интерфейс ===
together {
    class MainWindow {
        - companyWidget : QWidget
        - employeeTab : QWidget
        - employeeTable : QTableWidget
        - employeeAddBtn : QPushButton
        - employeeSearchBtn : QPushButton
        - employeeSearchEdit : QLineEdit
        - projectTab : QWidget
        - projectListContainer : QWidget
        - projectDetailHeaderContainer : QWidget
        - projectDetailContainer : QWidget
        - projectTable : QTableWidget
        - projectTasksTable : QTableWidget
        - projectAddBtn : QPushButton
        - projectDetailCloseBtn : QPushButton
        - projectDetailAutoAssignBtn : QPushButton
        - projectDetailTitle : QLabel
        - projectDetailInfoText : QTextEdit
        - mainTabWidget : QTabWidget
        - statsTab : QWidget
        - statisticsChartWidget : QWidget
        - statisticsChartInnerWidget : QWidget
        - statisticsText : QTextEdit
        - companySelector : QComboBox
        - companyAddBtn : QPushButton
        - companyDeleteBtn : QPushButton
        - companies : vector
        - currentCompany : Company
        - currentCompanyIndex : int
        - nextEmployeeId : int
        - nextProjectId : int
        - detailedProjectId : int
        - pendingTaskSelectionId : int
        --
        + MainWindow(QWidget)
        + ~MainWindow()
        + closeEvent(QCloseEvent) : void
        + validateAndFixProjectAssignments(Company) : void
        + getDataDirectory() : QString
        --
        + initializeCompanySetup() : void
        + addEmployee() : void
        + editEmployee() : void
        + deleteEmployee() : void
        + fireEmployee() : void
        + searchEmployee() : void
        + refreshEmployeeTable() : void
        + addProject() : void
        + editProject() : void
        + deleteProject() : void
        + refreshProjectTable() : void
        + openProjectDetails() : void
        + closeProjectDetails() : void
        + autoAssignDetailedProject() : void
        + assignTaskFromDetails(int, int) : void
        + addProjectTask() : void
        + assignEmployeeToTask() : void
        + autoAssignToProject(int) : void
        + viewProjectAssignments() : void
        + viewEmployeeHistory() : void
        + showStatistics() : void
        + refreshAllData() : void
        + addCompany() : void
        + switchCompany() : void
        + deleteCompany() : void
        + refreshCompanyList() : void
    }

    class StatisticsChartWidget {
        - company : Company
        - animationTimer : QTimer
        - animationProgress : double
        --
        + StatisticsChartWidget(QWidget)
        + setData(Company) : void
        + paintEvent(QPaintEvent) : void
    }

    MainWindow --> Company
    MainWindow --> StatisticsChartWidget
    StatisticsChartWidget --> Company
    StatisticsChartWidget --> Employee
}

' === Helpers - Validation - Валидация ===
together {
    class ValidationHelper {
        +  validateNonEmpty(QString, QString, QDialog) : bool
        +  validateDouble(QString, double, double, double, QString, QDialog) : bool
        +  validateInt(QString, int, int, int, QString, QDialog) : bool
        +  validateDateRange(QDate, QDate, QDialog) : bool
    }

    class EmployeeValidator {
        +  validateEmployeeTypeFields(QString, QDialog, QLineEdit, QLineEdit, QLineEdit, QLineEdit, QLineEdit, QLineEdit) : bool
    }

    class ExceptionHandler {
        +  handleCompanyException(CompanyException, QDialog, QString) : void
        +  handleFileManagerException(FileManagerException, QDialog, QString) : void
        +  handleGenericException(std::exception, QDialog) : void
    }

    ExceptionHandler ..> CompanyException
    ExceptionHandler ..> FileManagerException
}

' === Helpers - Dialogs - Диалоги ===
together {
    class EmployeeDialogHelper {
        +  void createEmployeeDialog(...)
        +  void createEditEmployeeDialog(...)
        +  void populateEmployeeFields(...)
        +  checkDuplicateEmployee(QString, Company) : bool
        +  checkDuplicateEmployeeOnEdit(QString, int, Company) : bool
        +  createEmployeeFromType(...) : Employee
    }

    class EmployeeDialogHandler {
        +  bool processAddEmployee(...)
        +  bool processEditEmployee(...)
    }

    class ProjectDialogHelper {
        +  createProjectDialogFields(QDialog, QFormLayout, ProjectDialogFields) : void
        +  populateProjectDialogFields(Project, ProjectDialogFields) : void
        +  setupClientFieldsVisibility(ProjectDialogFields) : void
    }

    class TaskDialogHelper {
        +  createAddTaskDialog(QDialog, QFormLayout, QLineEdit, QComboBox, QLineEdit, QLineEdit) : void
        +  validateAndAddTask(QString, QString, int, int, int, Company, QDialog) : bool
    }

    class DialogHelper {
        +  createHtmlDialog(QDialog, QString, QString, int, int) : void
    }

    EmployeeDialogHelper --> Employee
    EmployeeDialogHelper --> Company
    EmployeeDialogHandler --> Employee
    EmployeeDialogHandler --> Company
    ProjectDialogHelper --> Project
    TaskDialogHelper --> Company
    TaskDialogHelper --> Task
}

' === Helpers - Display and UI - Отображение ===
together {
    class DisplayHelper {
        +  displayEmployees(QTableWidget, Company, MainWindow) : void
        +  displayProjects(QTableWidget, Company, MainWindow) : void
        +  showCompanyInfo(QTextEdit, Company) : void
        +  showStatistics(QTextEdit, Company) : void
        +  formatProjectInfo(Employee, Company) : QString
        +  formatTaskInfo(Employee, Company) : QString
        +  formatEmploymentRate(double) : QString
    }

    class HtmlGenerator {
        +  generateProjectDetailHtml(Project, Company) : QString
        +  generateProjectAssignmentsHtml(Project, Company) : QString
        +  generateEmployeeHistoryHtml(Employee, Company, vector) : QString
    }

    class MainWindowUIBuilder {
        +  setupMainUI(MainWindow) : void
        +  setupEmployeeTab(MainWindow, QTabWidget) : void
        +  setupProjectTab(MainWindow, QTabWidget) : void
        +  setupStatisticsTab(MainWindow, QTabWidget) : void
        +  createCompanyWidget(MainWindow) : QWidget
    }

    class ActionButtonHelper {
        +  createEmployeeActionButtons(QTableWidget, int, MainWindow) : QWidget
        +  createProjectActionButtons(QTableWidget, int, MainWindow, bool) : QWidget
    }

    DisplayHelper --> Company
    DisplayHelper --> Employee
    DisplayHelper --> MainWindow
    HtmlGenerator --> Project
    HtmlGenerator --> Employee
    HtmlGenerator --> Company
    MainWindowUIBuilder --> MainWindow
    ActionButtonHelper --> MainWindow
}

' === Helpers - Business Logic - Бизнес-логика ===
together {
    class ProjectHelper {
        +  populateProjectTasksTable(QTableWidget, Project, MainWindow) : void
        +  clearProjectAllocatedHoursIfNoEmployees(Company, int) : void
        +  hasAssignedEmployees(Company, int) : bool
    }

    class TaskAssignmentHelper {
        +  getExpectedRoleForProjectStatus(QString) : QString
        +  populateEmployeeCombo(QComboBox, Company, int, QString, int) : void
        +  setupTaskCombo(QComboBox, vector, int) : void
        +  setupHoursEdit(QLineEdit, QComboBox, vector) : void
        +  setupEmployeeComboUpdate(QComboBox, QComboBox, QLabel, Company, int, QString) : void
    }

    class CompanyManager {
        +  initializeCompany(vector, Company, int, int, int, QComboBox) : void
        +  addCompany(vector, Company, int, QComboBox, QWidget) : void
        +  switchCompany(vector, Company, int, QComboBox, int) : void
        +  deleteCompany(vector, Company, int, QComboBox, QWidget) : void
        +  refreshCompanyList(vector, QComboBox) : void
    }

    ProjectHelper --> Company
    ProjectHelper --> Project
    ProjectHelper --> Task
    ProjectHelper --> MainWindow
    TaskAssignmentHelper --> Company
    TaskAssignmentHelper --> Project
    TaskAssignmentHelper --> Task
    CompanyManager --> Company
}

' === Data Management - Управление данными ===
together {
    class FileManager {
        +  saveCompany(Company, QString) : void
        +  saveEmployees(Company, QString) : void
        +  saveProjects(Company, QString) : void
        + saveTasks(Company, QString) : void
        + saveTaskAssignments(Company, QString) : void
        + loadCompany(QString) : Company
        + loadEmployees(Company, QString) : void
        + loadProjects(Company, QString) : void
        + loadTasks(Company, QString) : void
        + loadTaskAssignments(Company, QString) : void
        + loadFromFile(QString) : Company
    }

    class AutoSaveLoader {
        + getDataDirectory() : QString
        + autoSave(vector, MainWindow) : void
        + autoLoad(vector, Company, int, MainWindow) : void
        + clearDataFiles(QString) : void
    }

    class FileHelper {
        + clearAllDataFiles(QWidget) : void
    }

    FileManager --> Company
    FileManager --> Employee
    FileManager --> Project
    FileManager --> Task
    AutoSaveLoader --> Company
    AutoSaveLoader --> MainWindow
    FileHelper --> MainWindow
}

' === Utilities - Утилиты ===
together {
    class SafeValue<T> {
        + SafeValue(T, T, T)
        + bool isValidValue()
        + T getValue()
        + T getClampedValue()
        + void setValue(T)
    }
}

' === Связи между группами классов ===
MainWindow --> CompanyManager
MainWindow --> DisplayHelper
MainWindow --> HtmlGenerator
MainWindow --> ValidationHelper
MainWindow --> ExceptionHandler
MainWindow --> EmployeeDialogHelper
MainWindow --> EmployeeDialogHandler
MainWindow --> ProjectDialogHelper
MainWindow --> TaskDialogHelper
MainWindow --> ProjectHelper
MainWindow --> TaskAssignmentHelper
MainWindow --> FileManager
MainWindow --> AutoSaveLoader
MainWindow --> FileHelper

Company ..> EmployeeException
Company ..> CompanyException
Company ..> ProjectException
Company ..> TaskException
Project ..> TaskException
Task ..> TaskException
Employee ..> EmployeeException

@enduml